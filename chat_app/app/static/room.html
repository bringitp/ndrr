<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
</head>
<body>

    <div id="room-info">
        <!-- Room info will be populated here -->
    </div>

    <div>
        <h2>Post a Message</h2>
        <form id="message-form">
            <textarea id="message-content" placeholder="Enter your message" style="width: 350px; height: 120px;"></textarea>
            <button type="submit">Post</button>
        </form>
    </div>

    <div id="messages">
        <!-- Messages will be populated here -->
    </div>

    <script>
const TOKEN = "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI0QU1vTTBIa3JWaDBfalV0VHRLZjc5VlBXcTFQQVdlS3BwaWlySVpUSWdjIn0.eyJleHAiOjE2OTMwMzYxOTUsImlhdCI6MTY5MzAwMDE5NSwianRpIjoiZmFkZmYxMGItMjJhOS00MTk3LTllZGYtNjQ5ZDliOWVlNTQ3IiwiaXNzIjoiaHR0cHM6Ly9yb24tdGhlLXJvY2tlci5uZXQvYXV0aC9yZWFsbXMvbmRyciIsInN1YiI6IjFiN2U0N2MyLTY3ZTgtNDc1Zi1hOTBhLTQ3YjQwZGFjYTU2YiIsInR5cCI6IkJlYXJlciIsImF6cCI6InB5dGhvbi1jbGllbnQiLCJzZXNzaW9uX3N0YXRlIjoiMjNmNDA4MmUtYmFjZi00ZGJmLThiZmUtNTVhOTE3YTgwYmU5Iiwic2NvcGUiOiIiLCJzaWQiOiIyM2Y0MDgyZS1iYWNmLTRkYmYtOGJmZS01NWE5MTdhODBiZTkifQ.NiaUvdGLAeyFFh7ik4RF7Guy5qcEd0uVC25ElCkm8PakupvilBVByjgmgEn7Qfru6CXavw1BkCCybV5JdafdFqtz06gRozvY-twHsdhsV_5ct46wr0tRzwE2hQmb1QXQ9-DZCAYRQ7ZmxDhBzp27aX_qrH-BuiK4bug-pPAe6zSmazZCgfXaDwDf05ixkj1P2KGnfglKvUtqfArDjoU9jm2XoDGWVR4gmvGHjCiRajR0pOiXPzCxKN15ATpG3Jg1ZxDAfEqihd_0lKoSyEz6CFTis030x8m9BV1Hvu4cMr8DZOESirLEC6RtrukBDltouhDAID-mFAVaWPTZT0xB_g"; // Replace with your actual token
const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get('room_id');
const apiUrl = window.location.pathname.startsWith('/ndrr')
    ? `/ndrr/api/rooms/${roomId}/messages`
    : `/rooms/${roomId}/messages`;

const headers = new Headers();
headers.append("Authorization", `Bearer ${TOKEN}`);



function handleInvalidTokenError() {
    clearInterval(fetchInterval); // Stop the interval for fetching data

    const errorDiv = document.createElement("div");
    errorDiv.textContent = "Error: Token is invalid";
    document.body.appendChild(errorDiv);
}


function populateRoomInfo(room) {
    const roomInfoDiv = document.getElementById("room-info");
    roomInfoDiv.innerHTML = `
        <h3>Room Info</h3>
        <div>Room ID: ${room.room_id}</div>
        <div>Room Label: ${room.room_label}</div>
        <div>Room Name: ${room.room_name}</div>
        <div>Room Owner ID: ${room.room_owner_id}</div>
        <div>Room Max Capacity: ${room.room_max_capacity}</div>
        <div>Room Lux: ${room.room_lux}</div>
    `;
}

function fetchData() {
    fetch(apiUrl, { headers })
        .then(response => {
            if (response.status === 401) {
                handleInvalidTokenError();
                throw new Error("Token is invalid");
            }
            return response.json();
        })
        .then(data => {
            populateRoomInfo(data.room);
            const messagesDiv = document.getElementById("messages");
            messagesDiv.innerHTML = ""; // Clear previous messages

            const messageList = document.createElement("ul");
            data.messages.forEach(message => {
                const listItem = document.createElement("li");
                listItem.innerHTML = `
                    <div>id: ${message.id}</div>
                    <div>Sender: ${message.sender.username}</div>
                    <div>Avatar: ${message.sender.avatar}</div>
                    <div>Karma: ${message.sender.karma}</div>
                    <div><strong>Content:</strong> ${message.content}</div>
                    <div>Profile: ${message.sender.profile}</div>
                `;
                messageList.appendChild(listItem);
            });
            messagesDiv.appendChild(messageList);
        })
        .catch(error => {
            console.error("Error fetching data:", error);
            const errorDiv = document.createElement("div");
            errorDiv.textContent = `Error fetching data: ${error.message}`;
            document.body.appendChild(errorDiv);
        });
}

// Fetch data initially and set interval for regular updates
fetchData();
const fetchInterval = setInterval(fetchData, 1250);

const messageForm = document.getElementById("message-form");
const messageContentInput = document.getElementById("message-content");

messageForm.addEventListener("submit", function(event) {
    event.preventDefault();

    const messageContent = messageContentInput.value;

    const postData = {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${TOKEN}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ message_content: messageContent })
    };

    fetch(apiUrl, postData)
        .then(response => {
            if (response.status === 401) {
                handleInvalidTokenError();
                throw new Error("Token is invalid");
            }
            return response.json();
        })
        .then(data => {
            messageContentInput.value = "";
        })
        .catch(error => {
            console.error("Error posting message:", error);
        });
});
    </script>
</body>
</html>
